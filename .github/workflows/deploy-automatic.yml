name: ğŸš€ Deploy to Portainer Automatically

on:
  workflow_run:
    workflows: ["ğŸ³ Build and Push Backend Docker Image", "ğŸ…°ï¸ Build and Push Frontend Docker Image"]
    types:
      - completed
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸš€ Deploy to Portainer via API
      run: |
        # Obtener stack ID
        STACK_RESPONSE=$(curl -s -H "X-API-Key: ${{ secrets.PORTAINER_TOKEN }}" \
          "${{ secrets.PORTAINER_URL }}/api/stacks")
        
        STACK_ID=$(echo $STACK_RESPONSE | jq -r '.[] | select(.Name=="prueba_github") | .Id')
        
        if [ "$STACK_ID" = "null" ] || [ -z "$STACK_ID" ]; then
          echo "âŒ No se encontrÃ³ el stack 'prueba_github'"
          exit 1
        fi
        
        echo "âœ… Stack ID encontrado: $STACK_ID"
        
        # Actualizar stack
        UPDATE_RESPONSE=$(curl -s -X POST \
          -H "X-API-Key: ${{ secrets.PORTAINER_TOKEN }}" \
          -H "Content-Type: application/json" \
          "${{ secrets.PORTAINER_URL }}/api/stacks/$STACK_ID/update" \
          -d '{"prune": true}')
        
        if [ $? -eq 0 ]; then
          echo "âœ… Deployment completado automÃ¡ticamente!"
          echo "ğŸ“Š Respuesta: $UPDATE_RESPONSE"
        else
          echo "âŒ Error en el deployment"
          exit 1
        fi

    - name: ğŸ“ Deployment Status
      run: |
        echo "ğŸš€ Workflow: ${{ github.event.workflow_run.name }}"
        echo "âœ… Resultado: ${{ github.event.workflow_run.conclusion }}"
        echo "ğŸ• Completado: ${{ github.event.workflow_run.updated_at }}"
